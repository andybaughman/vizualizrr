<!doctype html>
<html>

<head>
	<title>Vizualizr</title>

	<link href="http://fonts.googleapis.com/css?family=Alike" rel="stylesheet" type="text/css">
	<link href="/static/css/bootstrap.css" rel="stylesheet" type="text/css">
	<link href="/static/css/styles.css" rel="stylesheet" type="text/css">

	<script src="/static/js/pitchdetector.js"></script>
	<script src="/static/js/three.js"></script>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
</head>

<body>

	<button onclick="this.innerText = togglePlayback()">use demo audio</button>
	<button onclick="toggleLiveInput()">use live input</button>

	<div id="detector" class="vague">
		<div class="pitch"><span id="pitch" onChange="function2(this)">--</span>Hz</div>
		<div class="note"><span id="note">--</span></div>   
		<div id="detune"><span id="detune_amt">--</span><span id="flat">cents &#9837;</span><span id="sharp">cents &#9839;</span>
	</div>

	<div id="result"></div>

	<!-- start contours -->
	<canvas id="contours" width="675" height="675" style="border: 1px solid #333; background-color: transparent; position: absolute; left: 0;z-index: 2;"></canvas>
	<!-- end contours -->

	<img src="../static/images/user/moon.jpg" width="675" height="675" style="position: absolute;left: 0;" />


	<script>

		$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

		$(window).load(function() {


// GENERAL TO-DOS - 
//		Have user choose whether they want to upload a file or use streaming before prompting them to upload?


			// Initialize globals

			// Unset contourData for each page load
			$.contourData = undefined;
			// Initialize contourData object
		    $.contourData = {};
		    
		    // Initialize audioData as an array
		    $.audioData = [];
		    // Set window size for analysis comparison
		    $.audioWindowSize = 500;
		    // Set threshold for color and image updates
		    $.pitchThreshold = 500;

// TO-DO - set loading image that is replace once init() is called


			/*
			 * Get contours from Python
			 */
			function getContourArray() {	
				$.ajax({
		            type: "GET",
		            url: $SCRIPT_ROOT + "/upload",
		            data: { processContours: 1 },
		            contentType: "application/json; charset=utf-8",
		           	success: function( allContourData ) {
		            	
		            	allContourData = jQuery.parseJSON( allContourData );
		            	
		            	// Set contour data to global $.contourData.contourArray
		            	setContourArray( allContourData );
		            	
		            	beginProcessing();

		            }
		        }); 

		    	return false;
			}


			/**
			 * Add contours to globals
			 */
			function setContourArray( allContourData ) {
				// All contour data
				$.contourData.contourArray = allContourData;
				// Sets which contour should be rendered, constantly updated as the audio plays
				$.contourData.currentContour = 0;
			}

			
			getContourArray();


			function beginProcessing() {
			
				// Let's get going! 
				init();


				function init() {
// TO-DO - hide the loading image
					// render 30 times a second (should also look 
					// at requestAnimationFrame) 
					setInterval(update,1000/5); //1000/5

				}


				/**
				 * Update contours and colors
				 *
				 * Store pitch audio data for ongoing analysis
				 */
				function update() {
					
					// If audio pitch is above the threshold
					if(analyzeAudio() > 0) {

						// Draw contours on top of image
						// drawContours();

					}

// TO-DO - only call drawContours(); within the conditional above once the audio thesholding is finalized
					drawContours();

				}


				/**
				 * Returns a random integer between min and max
				 */
				function getRandomInt (min, max) {

				    return Math.floor( Math.random() * (max - min + 1) ) + min;

				}

				/**
				 * Returns contours of new image
				 */
				function updateImage() {
// TO-DO - pull in next user image and increment count to keep track of which image is being used
				}

				/**
				 * Returns an rgba(0,0,0,0) string based on pitch and note values of audio
				 */
				function updateColor() {
					
					// Get pitch value
					var pitch = document.getElementById('pitch').innerHTML;


					// Get note value
					var note = document.getElementById('note').innerHTML;


					// Set color temperature based on pitch
					colorTemp = 'cool';
// TO-DO - need to dynamically set pitch threshold, instead of using static 500 $.pitchThreshold
					if(pitch > $.pitchThreshold) colorTemp = 'warm';


					// Set color based on temperature
					if(colorTemp == 'warm') {
						// Generate warm color
						// red 		255,0,0
						// orange 	255,165,0
						// yellow 	255,255,0
						colorR = getRandomInt( 205, 255 );
						colorG = getRandomInt( 0, 255 );
						colorB = 0;
					
					} else {
						// Generate cool color
						// blue 	0,0,255
						// green 	0,128,0 
						// lime  	0,255,0 
						// purple 	128,0,128
						// magenta 	255,0,255
						colorR = 0;
						colorG = getRandomInt( 0, 255 );
						colorB = getRandomInt( 205, 255 );
					}


					// Set opacity
					opacity = 0.28;

					switch(note) {
						case "A":
						case "A#":
							opacity = 0.84;
						break;
						case "B":
							opacity = 0.98;
						break;
						case "C":
						case "C#":
							opacity = 0.14;
						break;
						case "D":
						case "D#":
							opacity = 0.28;
						break;
						case "E":
						case "E#":
							opacity = 0.42;
						break;
						case "F":
						case "F#":
							opacity = 0.56;
						break;
						case "G":
						case "G#":
							opacity = 0.70;
						break;
					}


					return "rgba("+colorR+","+colorG+","+colorB+","+opacity+")";
		        
		        }


		        /**
		         * Increment current contour being used
		         */
		        function setNextContour() {

		        	var random = true;

		        	contourLength = $.contourData.contourArray[0].length - 1;

					if(random) {
						$.contourData.currentContour = getRandomInt( 0, contourLength );
					} else if($.contourData.currentContour < contourLength) {
						$.contourData.currentContour++;
					} else {
						$.contourData.currentContour = 0;
					}

		        }


		        /**
		         * Draw contours in canvas
		         */
				function drawContours() {
					
					canvas = document.getElementById( "contours" );
					context = canvas.getContext( "2d" );
					
					// Clear all contours in context
					//canvas.innerHTML = '';
					context.clearRect(0, 0, canvas.width, canvas.height);

					// Set fill color
					context.fillStyle = updateColor();

					context.beginPath();

					thisContour = $.contourData.contourArray[0][$.contourData.currentContour]["py/numpy.ndarray"]["values"];

					for (var i = 0; i < thisContour.length; i++) {
						context.lineTo(thisContour[i][0][0],thisContour[i][0][1]);
					};

					context.fill();

					setNextContour();
				}

				//drawContours();


				/**
		         * Analyse a window of audio data
		         */
				function analyzeAudio() {

					$.audioData.push(document.getElementById('pitch').innerHTML);

					var sum = 0;
					var audioInt = 0;
					var audioOutInt = 0;

					for(i = 0; i <= $.audioWindowSize; i++) {
				       
						audioInt = parseInt($.audioData[ $.audioData.length - i ]);//$.audioData.length - 
				        if(audioInt > 0) {
				        
// TO-DO - Unset data that is out of range
				        	//audioOutInt = parseInt($.audioData[ $.audioData.length - i ]);
				        	//if(audioOutInt < 1) { audioOutInt = 0; }
				        	//sum -= audioOutInt;
				            
				            // Set data that is in range
				            sum += audioInt;
				        }

				    }


					var audioWindowAverage  = sum / $.audioWindowSize;

					//console.log(audioWindowAverage);

					if(audioWindowAverage > $.pitchThreshold) {
						return 1;
					}

					return 0;
				}


			}

		});

	</script>

</body>
</html>